pipeline {
    agent any
    environment {
        EC2_USER = "ubuntu"                       // Ubuntu EC2 username
        EC2_HOST = "65.1.111.60"                  // Your EC2 public IP
        REMOTE_DIR = "/var/www/html"
        SSH_CREDENTIAL_ID = "ec2-ssh-key"         // Jenkins credential ID with AdityaKadam.pem
        GIT_REPO = "https://github.com/Adi-Kadam-07/Static-Web-Deployment--Terra-Jen.git" // Your repo URL
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Deploy to EC2 via SSH') {
            steps {
                script {
                    if (!env.EC2_HOST?.trim()) {
                        error "EC2_HOST environment variable is empty. Set EC2_HOST to instance public IP."
                    }
                }

                // Use Jenkins SSH credential
                sshagent([env.SSH_CREDENTIAL_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'bash -s' <<'ENDSSH'
                        set -e
                        cd ${REMOTE_DIR}
                        if [ -d .git ]; then
                            /usr/bin/git pull origin main || true
                        else
                            /usr/bin/git clone ${GIT_REPO} ${REMOTE_DIR}
                        fi
                        sudo chown -R www-data:www-data ${REMOTE_DIR}
                        sudo chmod -R 755 ${REMOTE_DIR}
                        sudo systemctl restart nginx
                    ENDSSH
                    """
                }
            }
        }

        stage('Validation') {
            steps {
                echo "Deployment finished. Check your website at http://${EC2_HOST}/"
            }
        }
    }
}

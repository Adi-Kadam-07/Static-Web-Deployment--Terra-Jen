pipeline {
    agent any
    environment {
        EC2_USER = "ubuntu"                       // EC2 username
        EC2_HOST = "65.1.111.60"                  // EC2 public IP
        REMOTE_DIR = "/var/www/html"              // Deployment directory
        SSH_CREDENTIAL_ID = "ec2-ssh-key"         // Jenkins SSH credential ID
        GIT_REPO = "https://github.com/Adi-Kadam-07/Static-Web-Deployment--Terra-Jen.git" // Your repo
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Deploy to EC2 via SSH') {
            steps {
                sshagent([env.SSH_CREDENTIAL_ID]) {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} 'bash -s' <<ENDSSH
                        set -e

                        # Mark the directory as safe for Git
                        git config --global --add safe.directory ${REMOTE_DIR}

                        # Ensure deployment directory exists
                        sudo mkdir -p ${REMOTE_DIR}

                        # Pull latest changes if repo exists, else clone
                        if [ -d ${REMOTE_DIR}/.git ]; then
                            sudo git -C ${REMOTE_DIR} pull origin main || true
                        else
                            sudo git clone ${GIT_REPO} ${REMOTE_DIR}
                        fi

                        # Fix permissions for Nginx
                        sudo chown -R www-data:www-data ${REMOTE_DIR}
                        sudo chmod -R 755 ${REMOTE_DIR}

                        # Ensure index.html exists
                        if [ ! -f ${REMOTE_DIR}/index.html ]; then
                            echo '<h1>Deployment successful!</h1>' | sudo tee ${REMOTE_DIR}/index.html
                        fi

                        # Restart Nginx
                        sudo systemctl restart nginx
ENDSSH
                    """
                }
            }
        }

        stage('Validation') {
            steps {
                echo "Deployment finished. Open http://${EC2_HOST}/ to check your website."
            }
        }
    }
}
